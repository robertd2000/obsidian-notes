# Processing Service: Центральный мозг системы мониторинга транспорта

## Основная суть и философия

Processing Service — это сердце всей системы мониторинга транспорта. Если представить всю архитектуру как человеческое тело, то:

- **Ingestion Service** — это руки, которые принимают данные от устройств
- **Real-time Service** — это рот, который говорит с клиентами
- **Processing Service** — это мозг, который все понимает, анализирует и принимает решения

Этот сервис не просто передает данные из точки А в точку Б. Он **осмысливает** их. Из сырых GPS-координат он создает целостную картину: какая машина, где находится, что делает, кто за рулем, какое задание выполняет, все ли в порядке, нужно ли что-то предпринимать.

## Глубокая обработка данных: от точек к смыслам

### Привязка данных к реальным объектам

Когда поступает сообщение с координатами, Processing Service первым делом отвечает на вопрос: "Чьи это данные?"

Он смотрит на IMEI устройства (уникальный идентификатор трекера) и идет в **Vehicle Registry Service** — специальный сервис-справочник, который знает всё о всех транспортных средствах компании.

Это как огромная картотека, где для каждого устройства есть полное досье:
- К какой машине оно привязано
- Какие характеристики у этой машины (марка, модель, год, цвет, грузоподъемность)
- Кто владелец, какое подразделение отвечает
- Какая страховка, когда техосмотр
- Какие особые возможности (рефрижератор, подъемник, опасный груз)

Но это только начало. Дальше Processing Service узнает:
- Кто сейчас за рулем (из системы учета рабочего времени)
- Какое задание выполняется (из системы планирования перевозок)
- Какой груз везет (из складской системы)
- Куда едет, к какому клиенту (из CRM системы)

### Географическая интерпретация

Координаты 55.7558, 37.6176 — это просто числа. Processing Service превращает их в осмысленную информацию:

1. **Геокодирование** — определение адреса: "Москва, Тверская улица, дом 1"
2. **Определение дороги** — не просто "где-то в Москве", а "едет по Тверской улице в сторону центра"
3. **Анализ окружения** — что вокруг: пробки, заправки, рестораны, парковки
4. **Проверка ограничений** — можно ли здесь ехать этой машине с этим грузом

Это похоже на то, как навигатор не просто показывает точку на карте, а понимает контекст: "Вы на МКАД, в левом ряду, пробка 5 км впереди, следующая заправка через 2 км".

### Вычисление метрик и показателей

Processing Service — это еще и бухгалтер, который ведет постоянный учет:

**Для каждой машины:**
- Сколько проехала сегодня, на этой неделе, в этом месяце
- Сколько топлива израсходовала, какой средний расход
- Сколько времени работала, сколько стояла
- Сколько нарушений правил было

**Для каждого водителя:**
- Сколько часов отработал, сколько осталось до обязательного отдыха
- Какой у него стиль вождения (агрессивный или спокойный)
- Сколько нарушений допустил
- Какая у него эффективность

**Для каждого задания:**
- Сколько уже выполнено, сколько осталось
- Соответствует ли графику, есть ли опоздание
- Какие затраты уже понесены, какая ожидается прибыль

### Обнаружение событий и аномалий

Самый важная часть работы Processing Service — это **понимание, что происходит что-то важное или неправильное**.

**События — это то, что нужно отметить:**
- Машина начала движение
- Машина остановилась
- Водитель сменился
- Задание началось или завершилось
- Машина приехала к клиенту

**Аномалии — это то, что требует внимания:**
- Машина отклоняется от маршрута
- Слишком долго стоит в неположенном месте
- Резко увеличился расход топлива
- Двигатель перегревается
- Водитель превышает скорость
- Машина въехала в запрещенную зону
- График срывается

Processing Service не просто фиксирует эти события — он **понимает их важность** и решает, что с ними делать. Мелкое превышение скорости — просто записать в журнал. Въезд в зону с опасным грузом — немедленно поднять тревогу.

## Взаимодействие с другими сервисами

Processing Service — самый общительный сервис в системе. Он постоянно разговаривает со всеми.

### 1. Общение с Ingestion Service (поставщик сырых данных)

```
Ingestion Service → Kafka → Processing Service
```

Это основной канал получения данных. Processing Service подписывается на топик Kafka, куда Ingestion Service складывает очищенные данные с устройств. Он как подписчик на газету — каждый день получает свежие новости.

**Важно:** Processing Service не общается с Ingestion Service напрямую. Они общаются через Kafka. Это как почтовый ящик: один кладет письма, другой забирает. Такое разделение позволяет:
- Каждому сервису работать в своем темпе
- Не зависеть от сбоев друг у друга
- Легко масштабироваться

### 2. Общение с Vehicle Registry Service (справочник машин и водителей)

```
Processing Service → gRPC/HTTP → Vehicle Registry Service
```

Vehicle Registry Service — это энциклопедия транспортной компании. Processing Service постоянно к ней обращается:
- "Какой машине принадлежит устройство с IMEI 868123456789012?"
- "Кто сейчас должен быть за рулем?"
- "Какое задание у этой машины?"
- "Какие характеристики у этого автомобиля?"

Ответы кэшируются в Redis, чтобы не спрашивать каждый раз одно и то же.

### 3. Общение с внешними сервисами (геоданные, погода, пробки)

```
Processing Service → API → Внешние сервисы
```

Processing Service выходит в большой мир:
- **Геосервисы** (Яндекс.Карты, Google Maps) — чтобы превращать координаты в адреса
- **Погодные сервисы** — чтобы знать, какая погода в месте нахождения машины
- **Сервисы пробок** — чтобы понимать, почему машина стоит
- **Сервисы дорожных событий** — чтобы знать о ДТП и ремонтах

Это общение требует денег (API обычно платные) и времени (запросы идут через интернет), поэтому Processing Service старается:
- Кэшировать ответы (адрес не изменится, погода меняется медленно)
- Делать запросы только когда действительно нужно
- Иметь запасные варианты (если один сервис не отвечает, спросить у другого)

### 4. Общение с Real-time Service (отправка данных клиентам)

```
Processing Service → Kafka → Real-time Service
```

После того как Processing Service всё обработал и понял, он отправляет результат Real-time Service, чтобы тот показал клиентам.

Но отправляет не всё подряд, а в трех видах:

**1. Легковесные обновления для карты** — только то, что нужно для отображения точки: координаты, направление, иконка. Минимум данных, отправляется часто.

**2. Полные данные по запросу** — когда клиент кликает на машину, чтобы увидеть подробности. Тогда отправляется всё: и про машину, и про водителя, и про задание.

**3. События и тревоги** — немедленно, как только что-то важное произошло.

### 5. Общение с базами данных (хранение информации)

Processing Service общается с тремя типами хранилищ:

**Redis (быстрая память)** — для хранения:
- Текущего состояния машин (последние позиции)
- Активных подписок клиентов
- Кэша часто запрашиваемых данных
- Временных вычислений

**PostgreSQL (надежное хранилище)** — для хранения:
- Событий и нарушений
- Информации о поездках
- Справочной информации
- Журналов действий

**ClickHouse (аналитическое хранилище)** — для хранения:
- Всей истории позиций
- Агрегированных данных для отчетов
- Данных для анализа трендов

### 6. Общение с Analytics Service (для глубокого анализа)

```
Processing Service → Kafka → Analytics Service
```

Часть данных Processing Service отправляет в Analytics Service — сервис, который занимается глубоким анализом и машинным обучением. Например:
- Предсказание поломок по косвенным признакам
- Анализ эффективности водителей
- Оптимизация маршрутов
- Выявление мошенничества

### 7. Общение с системами предприятия (ERP, CRM, WMS)

Processing Service интегрируется с другими системами компании:

**ERP (система управления предприятием)** — чтобы знать финансовую сторону: стоимость перевозки, оплату, рентабельность.

**CRM (система управления клиентами)** — чтобы знать особенности клиента, историю взаимоотношений, особые требования.

**WMS (складская система)** — чтобы знать подробности о грузе: что, сколько, как упаковано, температурный режим.

**HR система** — чтобы знать о водителях: графики работы, отпуска, квалификация.

Эта интеграция превращает Processing Service из простого трекера в **полноценную систему управления транспортными активами**.

## Архитектурная схема взаимодействий

```
┌─────────────────────────────────────────────────────────────────────┐
│                    Processing Service                              │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │                    Входящие данные                          │    │
│  │          (из Kafka от Ingestion Service)                    │    │
│  └──────────────────────────────┬──────────────────────────────┘    │
│                                  ↓                                    │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │                Обработка и обогащение                       │    │
│  │  • Привязка к ТС и водителю                                │    │
│  │  • Геокодирование и анализ местности                       │    │
│  │  • Вычисление метрик                                       │    │
│  │  • Обнаружение событий                                     │    │
│  └──────────────────────────────┬──────────────────────────────┘    │
│                                  ↓                                    │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │                Исходящие данные                             │    │
│  │        (отправка результата обработки)                      │    │
│  └──────┬────────────────┬────────────────┬────────────────────┘    │
│         │                │                │                         │
│         ↓                ↓                ↓                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                │
│  │ Real-time   │  │   Базы      │  │  Analytics  │                │
│  │ Service     │  │   данных    │  │  Service    │                │
│  │  (Kafka)    │  │ (3 вида)    │  │   (Kafka)   │                │
│  └─────────────┘  └─────────────┘  └─────────────┘                │
│                                                                     │
├─────────────────────────────────────────────────────────────────────┤
│        Внешние взаимодействия (через API)                          │
├─────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                │
│  │ Vehicle     │  │ Геосервисы  │  │  Погода,    │                │
│  │ Registry    │  │ (адреса,    │  │  пробки     │                │
│  │ Service     │  │  дороги)    │  │             │                │
│  └─────────────┘  └─────────────┘  └─────────────┘                │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │            Системы предприятия (ERP, CRM, WMS)              │    │
│  └─────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────┘
```

## Пример полного цикла обработки

Давайте проследим, как Processing Service обрабатывает одну точку от грузовика "Волво", который везет замороженную рыбу из Мурманска в Москву.

**Шаг 1: Получение данных**
```
Приходит сообщение: 
IMEI: 868123456789012
Координаты: 59.123456, 33.987654
Скорость: 75 км/ч
Топливо: 300 литров
Температура в рефрижераторе: -18°C
Время: 15:30 15 января 2024
```

**Шаг 2: Идентификация**
Processing Service смотрит в Vehicle Registry:
- IMEI 868123456789012 → грузовик "Волво" номер А123БВ777
- Сейчас за рулем должен быть водитель Иванов И.И.
- Задание №345: доставить 10 тонн рыбы из Мурманска в Москву
- Клиент: сеть ресторанов "Рыбный день"
- Температурный режим: -20°C ±2°C
- Срок доставки: до 18:00 16 января

**Шаг 3: Географический анализ**
Запрос к геосервису:
- Координаты → трасса М18, 50 км южнее Петрозаводска
- Ограничение скорости: 90 км/ч
- Пробок нет, погода: -5°C, снег
- Ближайшая заправка: через 80 км

**Шаг 4: Вычисление метрик**
Сравнение с предыдущей точкой:
- Проехал 75 км за последний час
- Расход топлива: 25 литров (нормально для этой погоды)
- От Мурманска уже 600 км, до Москвы 800 км
- По графику отставание 30 минут (из-за снегопада)

**Шаг 5: Проверка на аномалии**
- Скорость 75 при ограничении 90 — норма
- Температура -18 при требовании -20...+18 — немного выше, но в допуске
- Расход топлива в норме
- Отклонения от маршрута нет

**Шаг 6: Интеграция с бизнес-системами**
Запрос в ERP:
- Стоимость перевозки: 150 000 руб.
- Уже понесенные затраты: 45 000 руб.
- Штраф за опоздание: 10 000 руб. за каждый час

Запрос в CRM:
- Клиент "Рыбный день" — VIP, всегда требует точности
- Контактное лицо: Петров П.П., телефон +7 911 123-45-67

**Шаг 7: Формирование результата**
Processing Service создает три вида данных:

1. **Для карты (в Real-time Service):**
```
Грузовик А123БВ777 на трассе М18
Скорость: 75 км/ч
Статус: в пути, по графику
Иконка: синий грузовик
```

2. **Для диспетчера (событие):**
```
Грузовик А123БВ777: отставание 30 минут
Причина: снегопад
Рекомендация: уведомить клиента
```

3. **Для аналитики (в ClickHouse):**
```
Вся информация для отчетов и анализа
```

**Шаг 8: Принятие решений**
Processing Service автоматически:
- Отправляет SMS водителю: "Внимание, температура груза -18, требуется -20"
- Отправляет email диспетчеру: "Отставание 30 минут, снегопад"
- Обновляет ETA в системе планирования: прибытие в 17:30 вместо 17:00
- Резервирует место на складе в Москве на 17:30

## Сложности и вызовы

### 1. Согласованность данных

Processing Service работает с десятками источников данных, и они могут противоречить друг другу. Например:
- Система планирования говорит: "Машина должна быть в Москве"
- GPS говорит: "Машина в Петербурге"
- Водитель говорит по телефону: "У меня поломка"

Processing Service должен разрешать эти противоречия, понимая, каким источникам доверять больше.

### 2. Временные задержки

Данные приходят не мгновенно:
- GPS-трекер отправил данные в 15:30
- Ingestion Service получил в 15:31
- Processing Service обработал в 15:32
- Real-time Service отправил клиенту в 15:33

За 3 минуты машина на скорости 75 км/ч проедет почти 4 км. Processing Service должен учитывать эти задержки и, если нужно, экстраполировать положение.

### 3. Неполные данные

Не все данные приходят всегда:
- Иногда нет связи со спутниками — нет координат
- Иногда CAN-шина не работает — нет данных о топливе
- Иногда внешние сервисы не отвечают — нет информации о пробках

Processing Service должен уметь работать с неполной информацией, заполняя проблки разумными предположениями.

### 4. Масштабирование

В большой транспортной компании тысячи машин, каждая отправляет данные каждые 10-60 секунд. Processing Service должен обрабатывать:
- 10 000 машин × 6 сообщений в минуту = 60 000 сообщений в минуту
- Это 1 000 сообщений в секунду

И для каждого сообщения нужно:
- Сделать 3-5 запросов к другим сервисам
- Выполнить 10-20 вычислений
- Проверить 50-100 правил
- Отправить 2-3 результата

## Преимущества такого подхода

### Для диспетчеров
Они видят не просто точки на карте, а **полную картину**: какая машина, что везет, кто за рулем, по графику или нет, какие проблемы.

### Для водителей
Получают полезную информацию: где заправка подешевле, где пробка, где можно отдохнуть, напоминания о графике.

### Для клиентов
Могут отслеживать свой груз в реальном времени, получать точные прогнозы доставки, быть уверенными в сохранности груза.

### Для руководства
Имеют полную аналитику: какие машины эффективны, какие маршруты прибыльны, какие водители надежны, где возникают проблемы.

### Для бухгалтерии
Автоматический учет расхода топлива, амортизации, заработной платы, что уменьшает ошибки и мошенничество.

## Заключение

Processing Service — это действительно мозг системы. Он превращает сырые данные в осмысленную информацию, соединяет разрозненные системы в единое целое, автоматизирует рутинные задачи и помогает принимать правильные решения.

Без Processing Service система мониторинга транспорта была бы просто "GPS-трекером" — показывала бы точки на карте, но не давала бы понимания, что за этими точками стоит. С Processing Service каждая точка становится частью большой, понятной и управляемой системы.

Это сложный, ресурсоемкий, но абсолютно необходимый компонент, который делает всю систему не просто инструментом отслеживания, а **платформой для управления транспортным бизнесом**.