# –ì–ª—É–±–æ–∫–∏–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã –ø–æ —Å–∏—Å—Ç–µ–º–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞

## üß† –ü—Ä–æ –∞–ª–≥–æ—Ä–∏—Ç–º—ã –∏ –º–∞—Ç–µ–º–∞—Ç–∏–∫—É

### **1. –ö–∞–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∞–ª–≥–æ—Ä–∏—Ç–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –æ—Å—Ç–∞–Ω–æ–≤–æ–∫? –ö–∞–∫–∏–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã?**

**–û—Ç–≤–µ—Ç:**
```
–ê–ª–≥–æ—Ä–∏—Ç–º –î–µ—Ç–µ–∫—Ü–∏–∏ –û—Å—Ç–∞–Ω–æ–≤–æ–∫:
1. –í—Ö–æ–¥–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:
   - –ü–æ—Ä–æ–≥ —Å–∫–æ—Ä–æ—Å—Ç–∏: 3 –∫–º/—á
   - –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 5 –º–∏–Ω—É—Ç
   - –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–¥–∏—É—Å –æ—Å—Ç–∞–Ω–æ–≤–∫–∏: 50 –º–µ—Ç—Ä–æ–≤

2. –ê–ª–≥–æ—Ä–∏—Ç–º:
   –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è:
   - –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ç–æ—á–µ–∫ P1, P2, ..., Pn
   - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º is_stop = false
   - stop_start_time = null
   - stop_centroid = null

   –î–ª—è –∫–∞–∂–¥–æ–π —Ç–æ—á–∫–∏ Pi:
     if Pi.speed < 3 km/h:
       if not is_stop:
         // –ù–∞—á–∞–ª–æ –≤–æ–∑–º–æ–∂–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
         stop_start_time = Pi.timestamp
         stop_centroid = Pi.position
         is_stop = true
       else:
         // –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
         // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–µ–Ω—Ç—Ä–æ–∏–¥: weighted average –ø–æ–∑–∏—Ü–∏–π
         // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤—ã—à–ª–∏ –ª–∏ –∑–∞ —Ä–∞–¥–∏—É—Å 50–º
         distance = haversine(Pi.position, stop_centroid)
         if distance > 50m:
           // –≠—Ç–æ –Ω–æ–≤–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞
           —Ñ–∏–∫—Å–∏—Ä—É–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –æ—Å—Ç–∞–Ω–æ–≤–∫—É
           –Ω–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—É—é
     else:
       if is_stop:
         // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
         duration = Pi.timestamp - stop_start_time
         if duration >= 5 –º–∏–Ω—É—Ç:
           // –§–∏–∫—Å–∏—Ä—É–µ–º –æ—Å—Ç–∞–Ω–æ–≤–∫—É
           save_stop(stop_centroid, stop_start_time, Pi.timestamp)
         is_stop = false

3. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
   - –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–∫–æ–ª—å–∑—è—â–µ–µ –æ–∫–Ω–æ —Ç–æ—á–µ–∫ (100 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö)
   - –ö—ç—à–∏—Ä—É–µ–º —Ä–∞—Å—á–µ—Ç—ã —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–π
   - –£—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç (–∑–∞–∂–∏–≥–∞–Ω–∏–µ, –≥–µ–æ–∑–æ–Ω—ã)
```

### **2. –ö–∞–∫ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç–µ —Ç–æ—á–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É —Ç–æ—á–∫–∞–º–∏ —Å —É—á–µ—Ç–æ–º –∫—Ä–∏–≤–∏–∑–Ω—ã –ó–µ–º–ª–∏?**

**–û—Ç–≤–µ—Ç:**
```
–§–æ—Ä–º—É–ª–∞ –•–∞–≤–µ—Ä—Å–∏–Ω–∞ –¥–ª—è —Å—Ñ–µ—Ä–∏—á–µ—Å–∫–æ–π –ó–µ–º–ª–∏:

function haversine_distance(lat1, lon1, lat2, lon2):
    R = 6371.0  // –†–∞–¥–∏—É—Å –ó–µ–º–ª–∏ –≤ –∫–º
    
    // –ü–µ—Ä–µ–≤–æ–¥–∏–º –≥—Ä–∞–¥—É—Å—ã –≤ —Ä–∞–¥–∏–∞–Ω—ã
    œÜ1 = lat1 * œÄ/180
    œÜ2 = lat2 * œÄ/180
    ŒîœÜ = (lat2 - lat1) * œÄ/180
    ŒîŒª = (lon2 - lon1) * œÄ/180
    
    // –§–æ—Ä–º—É–ª–∞ –•–∞–≤–µ—Ä—Å–∏–Ω–∞
    a = sin(ŒîœÜ/2)¬≤ + cos(œÜ1) * cos(œÜ2) * sin(ŒîŒª/2)¬≤
    c = 2 * atan2(‚àöa, ‚àö(1-a))
    
    distance = R * c  // –≤ –∫–∏–ª–æ–º–µ—Ç—Ä–∞—Ö

–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:
1. –î–ª—è –∫–æ—Ä–æ—Ç–∫–∏—Ö —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–π (< 20 –∫–º) –∏—Å–ø–æ–ª—å–∑—É–µ–º —É–ø—Ä–æ—â–µ–Ω–Ω—É—é —Ñ–æ—Ä–º—É–ª—É:
   distance = ‚àö(Œîlat¬≤ + (Œîlon * cos(lat))¬≤) * 111.32 –∫–º

2. –î–ª—è –†–æ—Å—Å–∏–∏ —Å WGS84 –∏—Å–ø–æ–ª—å–∑—É–µ–º —ç–ª–ª–∏–ø—Å–æ–∏–¥–∞–ª—å–Ω—É—é –º–æ–¥–µ–ª—å:
   // –§–æ—Ä–º—É–ª–∞ –í–∏–Ω—Å–µ–Ω—Ç–∏
   a = 6378137.0  // –±–æ–ª—å—à–∞—è –ø–æ–ª—É–æ—Å—å
   b = 6356752.314245  // –º–∞–ª–∞—è –ø–æ–ª—É–æ—Å—å
   f = 1/298.257223563  // —Å–∂–∞—Ç–∏–µ

3. –í PostgreSQL –∏—Å–ø–æ–ª—å–∑—É–µ–º PostGIS —Ñ—É–Ω–∫—Ü–∏—é ST_DistanceSphere
   SELECT ST_DistanceSphere(
        ST_MakePoint(lon1, lat1),
        ST_MakePoint(lon2, lat2)
   ) / 1000.0  // —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –∫–º
```

### **3. –ö–∞–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∞–ª–≥–æ—Ä–∏—Ç–º —É–ø—Ä–æ—â–µ–Ω–∏—è —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏ –î—É–≥–ª–∞—Å–∞-–ü–µ–∫–µ—Ä–∞?**

**–û—Ç–≤–µ—Ç:**
```
–ê–ª–≥–æ—Ä–∏—Ç–º –î—É–≥–ª–∞—Å–∞-–ü–µ–∫–µ—Ä–∞ (–†–∞–º—Å–µ—Ä–∞):

–í—Ö–æ–¥:
  points[] - –º–∞—Å—Å–∏–≤ —Ç–æ—á–µ–∫ (lat, lon)
  epsilon - –ø–∞—Ä–∞–º–µ—Ç—Ä –¥–æ–ø—É—Å–∫–∞ –≤ –º–µ—Ç—Ä–∞—Ö
  
–ê–ª–≥–æ—Ä–∏—Ç–º:
  1. –ù–∞—Ö–æ–¥–∏–º —Ç–æ—á–∫—É —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ–º –æ—Ç –ª–∏–Ω–∏–∏ –º–µ–∂–¥—É –ø–µ—Ä–≤–æ–π –∏ –ø–æ—Å–ª–µ–¥–Ω–µ–π
  2. –ï—Å–ª–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ > epsilon:
     - –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ —É–ø—Ä–æ—â–∞–µ–º –ª–µ–≤—É—é —á–∞—Å—Ç—å
     - –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ —É–ø—Ä–æ—â–∞–µ–º –ø—Ä–∞–≤—É—é —á–∞—Å—Ç—å
     - –û–±—ä–µ–¥–∏–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
  3. –ò–Ω–∞—á–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—É—é –∏ –ø–æ—Å–ª–µ–¥–Ω—é—é —Ç–æ—á–∫—É

–†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è–º–∏:

function simplify_trajectory(points, epsilon, start_idx, end_idx):
    if end_idx - start_idx < 2:
        return points[start_idx:end_idx+1]
    
    // –ù–∞—Ö–æ–¥–∏–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ
    max_distance = 0
    index = start_idx
    
    // –õ–∏–Ω–∏—è –º–µ–∂–¥—É –ø–µ—Ä–≤–æ–π –∏ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ç–æ—á–∫–æ–π
    line_start = points[start_idx]
    line_end = points[end_idx]
    
    for i in range(start_idx + 1, end_idx):
        distance = perpendicular_distance(points[i], line_start, line_end)
        if distance > max_distance:
            max_distance = distance
            index = i
    
    if max_distance > epsilon:
        // –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ —É–ø—Ä–æ—â–∞–µ–º –æ–±–µ —á–∞—Å—Ç–∏
        left = simplify_trajectory(points, epsilon, start_idx, index)
        right = simplify_trajectory(points, epsilon, index, end_idx)
        // –û–±—ä–µ–¥–∏–Ω—è–µ–º, –∏—Å–∫–ª—é—á–∞—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ—á–∫–∏ index
        return left[:-1] + right
    else:
        return [line_start, line_end]

// –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ –ø–µ—Ä–ø–µ–Ω–¥–∏–∫—É–ª—è—Ä–Ω–æ–≥–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è
function perpendicular_distance(point, line_start, line_end):
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤–µ–∫—Ç–æ—Ä–Ω—É—é –º–∞—Ç–µ–º–∞—Ç–∏–∫—É
    // –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç —Ç–æ—á–∫–∏ –¥–æ –æ—Ç—Ä–µ–∑–∫–∞
    
    // –ü–µ—Ä–µ–≤–æ–¥–∏–º –≤ –º–µ—Ç—Ä—ã –ø—Ä–æ–µ–∫—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, UTM)
    point_m = to_utm(point)
    start_m = to_utm(line_start)
    end_m = to_utm(line_end)
    
    // –í–µ–∫—Ç–æ—Ä –æ—Ç—Ä–µ–∑–∫–∞
    v = end_m - start_m
    w = point_m - start_m
    
    // –ü—Ä–æ–µ–∫—Ü–∏—è w –Ω–∞ v
    c1 = dot(w, v)
    if c1 <= 0:
        return distance(point_m, start_m)
    
    c2 = dot(v, v)
    if c2 <= c1:
        return distance(point_m, end_m)
    
    // –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –ª–∏–Ω–∏–∏
    b = c1 / c2
    pb = start_m + b * v
    return distance(point_m, pb)

–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
1. –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏—Ç–µ—Ä–∞—Ç–∏–≤–Ω—É—é –≤–µ—Ä—Å–∏—é –≤–º–µ—Å—Ç–æ —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ–π –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–π
2. –ö—ç—à–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö epsilon
3. –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
4. –ü—Ä–∏–º–µ–Ω—è–µ–º –∞–ª–≥–æ—Ä–∏—Ç–º Visvalingam-Whyatt –∫–∞–∫ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—É –¥–ª—è –ª—É—á—à–µ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–æ—Ä–º—ã
```

## üóÑÔ∏è –ü—Ä–æ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ –∏–Ω–¥–µ–∫—Å—ã

### **4. –ö–∞–∫–∏–µ –∏–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã –≤ PostgreSQL –∏ –∫–∞–∫ –æ–Ω–∏ —Ä–∞–±–æ—Ç–∞—é—Ç?**

**–û—Ç–≤–µ—Ç:**
```
–ö–ª—é—á–µ–≤—ã–µ –∏–Ω–¥–µ–∫—Å—ã –≤ —Å–∏—Å—Ç–µ–º–µ:

1. B-Tree –∏–Ω–¥–µ–∫—Å –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:
   CREATE INDEX idx_vehicle_positions_vehicle_time 
   ON vehicle_positions(vehicle_id, timestamp DESC);
   
   –°—Ç—Ä—É–∫—Ç—É—Ä–∞: B-Tree
   –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø–æ–∑–∏—Ü–∏–∏ –º–∞—à–∏–Ω—ã
   –†–∞–∑–º–µ—Ä: –°—Ä–µ–¥–Ω–∏–π (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –º–∞—à–∏–Ω –∏ —Ç–æ—á–µ–∫)
   –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –ü—Ä–∏ –∫–∞–∂–¥–æ–π –≤—Å—Ç–∞–≤–∫–µ

2. GiST (GIST) –∏–Ω–¥–µ–∫—Å –¥–ª—è –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:
   CREATE INDEX idx_vehicle_positions_geo 
   ON vehicle_positions USING GIST (location);
   
   –°—Ç—Ä—É–∫—Ç—É—Ä–∞: R-Tree (–≤ GiST —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏)
   –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: –ü–æ–∏—Å–∫ –≤ bounding box, –ø–æ–∏—Å–∫ –±–ª–∏–∂–∞–π—à–∏—Ö —Å–æ—Å–µ–¥–µ–π
   –†–∞–∑–º–µ—Ä: –ë–æ–ª—å—à–æ–π (—Ö—Ä–∞–Ω–∏—Ç bounding box'—ã)
   –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏: –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏ && (–ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ), <-> (—Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ)

3. BRIN –∏–Ω–¥–µ–∫—Å –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤:
   CREATE INDEX idx_vehicle_positions_time_brin 
   ON vehicle_positions USING BRIN (timestamp);
   
   –°—Ç—Ä—É–∫—Ç—É—Ä–∞: Block Range Index
   –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: –î–∏–∞–ø–∞–∑–æ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (WHERE timestamp > ...)
   –†–∞–∑–º–µ—Ä: –û—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏–π
   –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏: –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–µ–Ω –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤ —Å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º –ø–æ—Ä—è–¥–∫–æ–º

4. –ß–∞—Å—Ç–∏—á–Ω—ã–π –∏–Ω–¥–µ–∫—Å –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–∞—à–∏–Ω:
   CREATE INDEX idx_active_vehicles 
   ON vehicle_positions(vehicle_id) 
   WHERE timestamp > NOW() - INTERVAL '1 hour';
   
   –°—Ç—Ä—É–∫—Ç—É—Ä–∞: B-Tree
   –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –Ω–µ–¥–∞–≤–Ω–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–∞—à–∏–Ω
   –†–∞–∑–º–µ—Ä: –ú–∞–ª–µ–Ω—å–∫–∏–π

5. –°–æ—Å—Ç–∞–≤–Ω–æ–π –∏–Ω–¥–µ–∫—Å –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:
   CREATE INDEX idx_analytics 
   ON vehicle_positions(vehicle_id, date_trunc('hour', timestamp), speed);
   
   –°—Ç—Ä—É–∫—Ç—É—Ä–∞: B-Tree
   –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: –ê–≥—Ä–µ–≥–∞—Ç–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –ø–æ —á–∞—Å–∞–º

–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤:

// –ò—Å–ø–æ–ª—å–∑—É–µ—Ç idx_vehicle_positions_vehicle_time
SELECT * FROM vehicle_positions 
WHERE vehicle_id = 'truck_123' 
ORDER BY timestamp DESC 
LIMIT 1;

// –ò—Å–ø–æ–ª—å–∑—É–µ—Ç idx_vehicle_positions_geo
SELECT * FROM vehicle_positions 
WHERE location && ST_MakeEnvelope(37.6, 55.7, 37.7, 55.8, 4326);

// –ò—Å–ø–æ–ª—å–∑—É–µ—Ç idx_vehicle_positions_time_brin
SELECT * FROM vehicle_positions 
WHERE timestamp > NOW() - INTERVAL '1 day';

–ü—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è:
1. –ò–Ω–¥–µ–∫—Å bloat: –†–µ–≥—É–ª—è—Ä–Ω—ã–π REINDEX CONCURRENTLY
2. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: ANALYZE –ø–æ—Å–ª–µ –±–æ–ª—å—à–∏—Ö –≤—Å—Ç–∞–≤–æ–∫
3. –ü–ª–∞–Ω –∑–∞–ø—Ä–æ—Å–æ–≤: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å pg_stat_statements
```

### **5. –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã vehicle_positions –∏ –∫–∞–∫–∏–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –¥–∞–µ—Ç?**

**–û—Ç–≤–µ—Ç:**
```
–ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (range partitioning):

-- –°–æ–∑–¥–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é —Ç–∞–±–ª–∏—Ü—É
CREATE TABLE vehicle_positions (
    id UUID DEFAULT gen_random_uuid(),
    vehicle_id VARCHAR(50),
    timestamp TIMESTAMPTZ NOT NULL,
    location GEOGRAPHY(POINT),
    speed DECIMAL(5,2)
) PARTITION BY RANGE (timestamp);

-- –°–æ–∑–¥–∞–µ–º –ø–∞—Ä—Ç–∏—Ü–∏–∏ –ø–æ –º–µ—Å—è—Ü–∞–º
CREATE TABLE vehicle_positions_2024_01 
PARTITION OF vehicle_positions 
FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');

CREATE TABLE vehicle_positions_2024_02 
PARTITION OF vehicle_positions 
FOR VALUES FROM ('2024-02-01') TO ('2024-03-01');

–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:

1. –ü—Ä–∏–Ω—Ü–∏–ø –ª–æ–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö:
   - –ì–æ—Ä—è—á–∏–µ –¥–∞–Ω–Ω—ã–µ (—Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü) –Ω–∞ –±—ã—Å—Ç—Ä—ã—Ö SSD
   - –•–æ–ª–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–ø—Ä–æ—à–ª—ã–µ –º–µ—Å—è—Ü—ã) –Ω–∞ HDD
   - –ê—Ä—Ö–∏–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ object storage

2. –ë—ã—Å—Ç—Ä–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö:
   -- –í–º–µ—Å—Ç–æ –º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ DELETE
   DELETE FROM vehicle_positions WHERE timestamp < '2023-01-01';
   
   -- –ë—ã—Å—Ç—Ä–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–∏
   DROP TABLE vehicle_positions_2023_01;

3. –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π –¥–æ—Å—Ç—É–ø:
   - –ö–∞–∂–¥–∞—è –ø–∞—Ä—Ç–∏—Ü–∏—è –∏–º–µ–µ—Ç —Å–≤–æ–∏ –∏–Ω–¥–µ–∫—Å—ã
   - –ó–∞–ø—Ä–æ—Å—ã –º–æ–≥—É—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –ø–æ —Ä–∞–∑–Ω—ã–º –ø–∞—Ä—Ç–∏—Ü–∏—è–º
   - COPY –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ø–∞—Ä—Ç–∏—Ü–∏–∏ –Ω–µ –±–ª–æ–∫–∏—Ä—É—é—Ç –≤—Å—é —Ç–∞–±–ª–∏—Ü—É

4. –£–ª—É—á—à–µ–Ω–Ω–æ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤:
   -- –ü—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∑–∞ —è–Ω–≤–∞—Ä—å 2024:
   SELECT * FROM vehicle_positions 
   WHERE timestamp >= '2024-01-01' 
     AND timestamp < '2024-02-01';
   
   –ü–ª–∞–Ω –∑–∞–ø—Ä–æ—Å–∞: –¢–æ–ª—å–∫–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–∏ 2024_01

5. –ò–Ω–¥–µ–∫—Å–Ω–æ–µ –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:
   -- –ò–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø–∞—Ä—Ç–∏—Ü–∏–π
   -- –ú–µ–Ω—å—à–∏–π —Ä–∞–∑–º–µ—Ä –∏–Ω–¥–µ–∫—Å–∞ –¥–ª—è –∫–∞–∂–¥–æ–π –ø–∞—Ä—Ç–∏—Ü–∏–∏
   -- –ë–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ

–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤ —Å–∏—Å—Ç–µ–º–µ:

-- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–π
CREATE OR REPLACE FUNCTION create_position_partitions()
RETURNS void AS $$
DECLARE
    next_month DATE;
    part_name TEXT;
BEGIN
    -- –°–æ–∑–¥–∞–µ–º –ø–∞—Ä—Ç–∏—Ü–∏—é –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –º–µ—Å—è—Ü
    next_month := DATE_TRUNC('month', CURRENT_DATE) + INTERVAL '1 month';
    part_name := 'vehicle_positions_' || 
                 TO_CHAR(next_month, 'YYYY_MM');
    
    EXECUTE format('
        CREATE TABLE IF NOT EXISTS %I 
        PARTITION OF vehicle_positions
        FOR VALUES FROM (%L) TO (%L)',
        part_name,
        next_month,
        next_month + INTERVAL '1 month'
    );
    
    -- –°–æ–∑–¥–∞–µ–º –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –Ω–æ–≤–æ–π –ø–∞—Ä—Ç–∏—Ü–∏–∏
    EXECUTE format('
        CREATE INDEX ON %I (vehicle_id, timestamp DESC)',
        part_name
    );
    
    EXECUTE format('
        CREATE INDEX ON %I USING GIST (location)',
        part_name
    );
END;
$$ LANGUAGE plpgsql;

-- –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ cron –∫–∞–∂–¥—ã–π –º–µ—Å—è—Ü
```

### **6. –ö–∞–∫ ClickHouse –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –º–∏–ª–ª–∏–∞—Ä–¥—ã —Å—Ç—Ä–æ–∫ –∏ –∫–∞–∫–∏–µ –¥–≤–∏–∂–∫–∏ —Ç–∞–±–ª–∏—Ü –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ?**

**–û—Ç–≤–µ—Ç:**
```
–î–≤–∏–∂–∫–∏ —Ç–∞–±–ª–∏—Ü –≤ ClickHouse:

1. MergeTree (–æ—Å–Ω–æ–≤–Ω–æ–π –¥–≤–∏–∂–æ–∫):
   CREATE TABLE gps_points (
       vehicle_id String,
       timestamp DateTime64(3),
       lat Float64,
       lon Float64,
       speed Float32,
       event_type LowCardinality(String)
   ) ENGINE = MergeTree()
   PARTITION BY toYYYYMM(timestamp)
   ORDER BY (vehicle_id, timestamp)
   TTL timestamp + INTERVAL 2 YEAR
   SETTINGS index_granularity = 8192;

   –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
   - –î–∞–Ω–Ω—ã–µ —Å–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –ø–æ ORDER BY –∫–ª—é—á—É
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–ª–∏—è–Ω–∏–µ (merge) –∫—É—Å–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö
   - –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ —Å–∂–∞—Ç–∏–µ (–¥–æ 10x)
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ TTL

2. ReplicatedMergeTree (–¥–ª—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏):
   ENGINE = ReplicatedMergeTree(
       '/clickhouse/tables/{shard}/gps_points',
       '{replica}'
   )
   -- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è –º–µ–∂–¥—É —É–∑–ª–∞–º–∏
   -- –û—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∏ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞

3. Distributed (–¥–ª—è —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏—è):
   CREATE TABLE gps_points_distributed AS gps_points
   ENGINE = Distributed(
       'cluster_name',        -- –∏–º—è –∫–ª–∞—Å—Ç–µ—Ä–∞
       'default',            -- –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
       'gps_points',         -- –ª–æ–∫–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞
       rand()                -- —Ñ—É–Ω–∫—Ü–∏—è —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏—è
   )

   –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
   - –ü—Ä–æ–∑—Ä–∞—á–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ —à–∞—Ä–¥–∞–º
   - –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
   - –ê–≥—Ä–µ–≥–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

4. AggregatingMergeTree (–¥–ª—è –∞–≥—Ä–µ–≥–∞—Ç–æ–≤):
   CREATE TABLE daily_stats (
       vehicle_id String,
       date Date,
       total_distance AggregateFunction(sum, Float64),
       avg_speed AggregateFunction(avg, Float32)
   ) ENGINE = AggregatingMergeTree()
   PARTITION BY toYYYYMM(date)
   ORDER BY (vehicle_id, date)

–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤:

1. –í–µ–∫—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ:
   -- ClickHouse –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –±–ª–æ–∫–∞–º–∏ –ø–æ 8192 —Å—Ç—Ä–æ–∫
   -- SIMD –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞
   -- –ú–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤ —Ñ—É–Ω–∫—Ü–∏–π

2. Column-based storage:
   // –í–º–µ—Å—Ç–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ —Å—Ç—Ä–æ–∫–∞–º:
   // [row1: {id, lat, lon}, row2: {id, lat, lon}, ...]
   
   // –•—Ä–∞–Ω–∏–º –ø–æ –∫–æ–ª–æ–Ω–∫–∞–º:
   // id_column: [id1, id2, id3, ...]
   // lat_column: [lat1, lat2, lat3, ...]
   // lon_column: [lon1, lon2, lon3, ...]
   
   –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
   - –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ —Å–∂–∞—Ç–∏–µ (–æ–¥–Ω–æ—Ç–∏–ø–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)
   - –ß—Ç–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã—Ö –∫–æ–ª–æ–Ω–æ–∫
   - –í–µ–∫—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞

3. –°–∂–∞—Ç–∏–µ –¥–∞–Ω–Ω—ã—Ö:
   -- LZ4 –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
   -- ZSTD –¥–ª—è –∞—Ä—Ö–∏–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
   -- Delta encoding –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤

4. –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –ø—Ä–æ–ø—É—Å–∫–∞–º–∏ (skip indexes):
   -- Minmax –∏–Ω–¥–µ–∫—Å: –•—Ä–∞–Ω–∏—Ç min/max –∑–Ω–∞—á–µ–Ω–∏—è
   -- Bloom filter –∏–Ω–¥–µ–∫—Å: –î–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏—è–º
   -- Tokenbf –∏–Ω–¥–µ–∫—Å: –î–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö

–ü—Ä–∏–º–µ—Ä —Å–ª–æ–∂–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞:

// –°—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å –ø–æ –º–∞—à–∏–Ω–∞–º –∑–∞ –¥–µ–Ω—å —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π
SELECT 
    vehicle_id,
    avg(speed) as avg_speed,
    count() as points_count
FROM gps_points
WHERE timestamp >= '2024-01-15'
  AND timestamp < '2024-01-16'
  AND speed > 0  // –ò—Å–∫–ª—é—á–∞–µ–º –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
  AND event_type != 'stop'  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–Ω–¥–µ–∫—Å –ø–æ event_type
GROUP BY vehicle_id
HAVING points_count > 100  // –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö
ORDER BY avg_speed DESC
LIMIT 100

// ClickHouse –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ—Ç:
// 1. –°–∫–∞–Ω–∏—Ä—É–µ—Ç —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –ø–∞—Ä—Ç–∏—Ü–∏–∏
// 2. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
// 3. –ê–≥—Ä–µ–≥–∏—Ä—É–µ—Ç –≤ –ø–∞–º—è—Ç–∏ —Å hash table
// 4. –ü—Ä–∏–º–µ–Ω—è–µ—Ç –≤–µ–∫—Ç–æ—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è avg()
```

## üåê –ü—Ä–æ —Å–µ—Ç—å –∏ –ø—Ä–æ—Ç–æ–∫–æ–ª—ã

### **7. –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–æ—Ç–æ–∫–æ–ª Teltonika –∏ –∫–∞–∫ –≤—ã –µ–≥–æ –ø–∞—Ä—Å–∏—Ç–µ?**

**–û—Ç–≤–µ—Ç:**
```
–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ Teltonika (Codec 8):

–ü–∞–∫–µ—Ç = [Preamble][Data Length][Data][CRC]

1. Preamble: 4 –±–∞–π—Ç–∞ –Ω—É–ª–µ–π (0x00000000)
2. Data Length: 4 –±–∞–π—Ç–∞ (—Ä–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö –≤ –±–∞–π—Ç–∞—Ö)
3. Data: [IMEI][Codec ID][Number of Data][AVL Data][Number of Data 2][CRC16]
4. CRC: 4 –±–∞–π—Ç–∞ CRC32

–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ AVL Data:
–ö–∞–∂–¥–∞—è –∑–∞–ø–∏—Å—å = [Timestamp][Priority][GPS Element][IO Element]

GPS Element = [Longitude][Latitude][Altitude][Angle][Satellites][Speed]

–ü–∞—Ä—Å–∏–Ω–≥ –≤ Go:

type AVLData struct {
    Timestamp   uint64    // 8 bytes
    Priority    uint8     // 1 byte
    Longitude   int32     // 4 bytes
    Latitude    int32     // 4 bytes
    Altitude    uint16    // 2 bytes
    Angle       uint16    // 2 bytes
    Satellites  uint8     // 1 byte
    Speed       uint16    // 2 bytes
    IOEvents    []IOEvent // variable
}

func parseTeltonikaPacket(data []byte) (*AVLData, error) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º preamble
    if !bytes.Equal(data[0:4], []byte{0,0,0,0}) {
        return nil, errors.New("invalid preamble")
    }
    
    // –ß–∏—Ç–∞–µ–º –¥–ª–∏–Ω—É –¥–∞–Ω–Ω—ã—Ö
    dataLength := binary.BigEndian.Uint32(data[4:8])
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º CRC
    expectedCRC := binary.BigEndian.Uint32(data[8+dataLength:])
    calculatedCRC := crc32.ChecksumIEEE(data[8:8+dataLength])
    if expectedCRC != calculatedCRC {
        return nil, errors.New("CRC mismatch")
    }
    
    // –ü–∞—Ä—Å–∏–º IMEI
    imei := string(data[8:23])  // 15 –±–∞–π—Ç
    
    // –ü–∞—Ä—Å–∏–º Codec ID
    codecID := data[23]
    
    // –ü–∞—Ä—Å–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π
    recordCount := data[24]
    
    // –ü–æ–∑–∏—Ü–∏—è –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ AVL –¥–∞–Ω–Ω—ã—Ö
    pos := 25
    
    var records []AVLData
    for i := 0; i < int(recordCount); i++ {
        record := parseAVLRecord(data[pos:])
        records = append(records, record)
        pos += record.Size()
    }
    
    return records, nil
}

–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏:
1. Big Endian –¥–ª—è –≤—Å–µ—Ö —á–∏—Å–ª–æ–≤—ã—Ö –ø–æ–ª–µ–π
2. Longitude/Latitude: int32 / 10000000.0 = –≥—Ä–∞–¥—É—Å—ã
3. Speed: uint16 / 10 = –∫–º/—á
4. Angle: uint16 / 10 = –≥—Ä–∞–¥—É—Å—ã

–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
1. Pool –±–∞–π—Ç–æ–≤—ã—Ö –±—É—Ñ–µ—Ä–æ–≤ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –∞–ª–ª–æ–∫–∞—Ü–∏–π
2. Zero-copy –ø–∞—Ä—Å–∏–Ω–≥ –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ
3. Batch –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–∞–∫–µ—Ç–æ–≤
4. –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤ –∑–Ω–∞—á–µ–Ω–∏–π
```

### **8. –ö–∞–∫ —É—Å—Ç—Ä–æ–µ–Ω WebSocket –ø—Ä–æ—Ç–æ–∫–æ–ª –∏ –∫–∞–∫ –≤—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç–µ —Ç—ã—Å—è—á–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π?**

**–û—Ç–≤–µ—Ç:**
```
–°—Ç—Ä—É–∫—Ç—É—Ä–∞ WebSocket —Ñ—Ä–µ–π–º–∞:

0                   1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-------+-+-------------+-------------------------------+
|F|R|R|R| opcode|M| Payload len |    Extended payload length    |
|I|S|S|S|  (4)  |A|     (7)     |             (16/64)           |
|N|V|V|V|       |S|             |   (if payload len==126/127)   |
| |1|2|3|       |K|             |                               |
+-+-+-+-+-------+-+-------------+ - - - - - - - - - - - - - - - +
|     Extended payload length continued, if payload len == 127  |
+ - - - - - - - - - - - - - - - +-------------------------------+
|                               |Masking-key, if MASK set to 1  |
+-------------------------------+-------------------------------+
| Masking-key (continued)       |          Payload Data         |
+-------------------------------- - - - - - - - - - - - - - - - +
:                     Payload Data continued ...                :
+ - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +
|                     Payload Data continued ...                |
+---------------------------------------------------------------+

–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ Go —Å gorilla/websocket:

// –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è–º–∏
type WebSocketManager struct {
    connections sync.Map // map[string]*ClientConnection
    broadcast   chan []byte
    register    chan *ClientConnection
    unregister  chan *ClientConnection
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
func (m *WebSocketManager) handleConnection(conn *websocket.Conn) {
    client := &ClientConnection{
        ID:     generateID(),
        Socket: conn,
        Send:   make(chan []byte, 256),
    }
    
    // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –∫–ª–∏–µ–Ω—Ç–∞
    m.register <- client
    
    // –ì–æ—Ä—É—Ç–∏–Ω–∞ –¥–ª—è —á—Ç–µ–Ω–∏—è
    go func() {
        defer func() {
            m.unregister <- client
            conn.Close()
        }()
        
        for {
            messageType, message, err := conn.ReadMessage()
            if err != nil {
                break
            }
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
            m.handleMessage(client, messageType, message)
        }
    }()
    
    // –ì–æ—Ä—É—Ç–∏–Ω–∞ –¥–ª—è –∑–∞–ø–∏—Å–∏
    go func() {
        defer conn.Close()
        
        for {
            select {
            case message, ok := <-client.Send:
                if !ok {
                    // –ö–∞–Ω–∞–ª –∑–∞–∫—Ä—ã—Ç
                    return
                }
                
                // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Å —Ç–∞–π–º–∞—É—Ç–æ–º
                conn.SetWriteDeadline(time.Now().Add(writeWait))
                err := conn.WriteMessage(websocket.TextMessage, message)
                if err != nil {
                    return
                }
            }
        }
    }()
}

–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –¥–ª—è —Ç—ã—Å—è—á —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π:

1. Epoll/kqueue –≤–º–µ—Å—Ç–æ select/poll:
   // Go net package –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π poller
   
2. Memory pooling:
   var messagePool = sync.Pool{
       New: func() interface{} {
           return make([]byte, 0, 1024)
       },
   }
   
3. Zero-copy –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ:
   // –ò—Å–ø–æ–ª—å–∑—É–µ–º WriteMessage —Å —É–∂–µ —Å–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
   // –ò–∑–±–µ–≥–∞–µ–º –ª–∏—à–Ω–∏—Ö –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–π

4. –°–∂–∞—Ç–∏–µ WebSocket (permessage-deflate):
   conn.EnableWriteCompression(true)
   conn.SetCompressionLevel(flate.BestSpeed)

5. Batch –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π:
   // –í–º–µ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–∞–∂–¥–æ–º—É –∫–ª–∏–µ–Ω—Ç—É –æ—Ç–¥–µ–ª—å–Ω–æ
   type BroadcastGroup struct {
       clients []*ClientConnection
       messages [][]byte
   }
   
   func (g *BroadcastGroup) Send() {
       for _, client := range g.clients {
           select {
           case client.Send <- g.messages:
               // –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
           default:
               // –ë—É—Ñ–µ—Ä –ø–æ–ª–æ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
               metrics.DroppedMessages.Inc()
           }
       }
   }

6. Heartbeat –∏ —Ç–∞–π–º–∞—É—Ç—ã:
   // Ping/pong –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
   conn.SetReadDeadline(time.Now().Add(pongWait))
   conn.SetPongHandler(func(string) error {
       conn.SetReadDeadline(time.Now().Add(pongWait))
       return nil
   })
   
   // –¢–∞–π–º–µ—Ä –¥–ª—è ping
   ticker := time.NewTicker(pingPeriod)
   defer ticker.Stop()
   
   for {
       select {
       case <-ticker.C:
           conn.SetWriteDeadline(time.Now().Add(writeWait))
           err := conn.WriteMessage(websocket.PingMessage, nil)
           if err != nil {
               return
           }
       }
   }
```

## ‚ö° –ü—Ä–æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### **9. –ö–∞–∫–∏–µ –º–µ—Ç–æ–¥—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —Å –ø–∞–º—è—Ç—å—é –≤ Go?**

**–û—Ç–≤–µ—Ç:**
```
1. Pool –æ–±—ä–µ–∫—Ç–æ–≤ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –∞–ª–ª–æ–∫–∞—Ü–∏–π:
   var bufferPool = sync.Pool{
       New: func() interface{} {
           return make([]byte, 0, 4096)
       },
   }
   
   // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
   buf := bufferPool.Get().([]byte)
   buf = buf[:0]  // reset
   // —Ä–∞–±–æ—Ç–∞ —Å buf
   bufferPool.Put(buf)

2. Reuse —Å—Ç—Ä—É–∫—Ç—É—Ä —á–µ—Ä–µ–∑ sync.Pool:
   type Message struct {
       VehicleID string
       Position  GeoPoint
   }
   
   var messagePool = sync.Pool{
       New: func() interface{} { return &Message{} },
   }
   
   msg := messagePool.Get().(*Message)
   // –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
   messagePool.Put(msg)

3. –ü—Ä–µ–∞–ª–ª–æ–∫–∞—Ü–∏—è —Å–ª–∞–π—Å–æ–≤:
   // –ü–ª–æ—Ö–æ: append –±—É–¥–µ—Ç –∞–ª–ª–æ—Ü–∏—Ä–æ–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑
   var points []Point
   for i := 0; i < 10000; i++ {
       points = append(points, Point{})
   }
   
   // –•–æ—Ä–æ—à–æ: –ø—Ä–µ–∞–ª–ª–æ—Ü–∏—Ä—É–µ–º –ø–∞–º—è—Ç—å
   points := make([]Point, 0, 10000)
   for i := 0; i < 10000; i++ {
       points = append(points, Point{})
   }

4. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ []byte –≤–º–µ—Å—Ç–æ string –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ:
   // string –Ω–µ–∏–∑–º–µ–Ω—è–µ–º –∏ —Å–æ–∑–¥–∞–µ—Ç –∫–æ–ø–∏–∏
   // []byte –º–æ–∂–Ω–æ reuse
   
   func parsePacket(data []byte) {
       // –†–∞–±–æ—Ç–∞–µ–º —Å data –Ω–∞–ø—Ä—è–º—É—é
       imei := string(data[0:15])  // –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–æ
   }

5. Stack allocation –¥–ª—è –º–∞–ª–µ–Ω—å–∫–∏—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä:
   // Go –∞–ª–ª–æ—Ü–∏—Ä—É–µ—Ç –Ω–∞ —Å—Ç–µ–∫–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã < 64KB
   // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —É–∫–∞–∑–∞—Ç–µ–ª—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
   
   func createPoint(lat, lon float64) Point {
       return Point{Lat: lat, Lon: lon}  // –Ω–∞ —Å—Ç–µ–∫–µ
   }

6. GC tuning:
   // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ GOGC
   export GOGC=100  // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
   // –∏–ª–∏ –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ
   debug.SetGCPercent(100)
   
   // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ ballast –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è —á–∞—Å—Ç–æ—Ç—ã GC
   func main() {
       // –°–æ–∑–¥–∞–µ–º ballast –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è —á–∞—Å—Ç–æ—Ç—ã GC
       ballast := make([]byte, 10<<30)  // 10GB
       _ = ballast
       // ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥
   }

7. –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏:
   // pprof –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
   import _ "net/http/pprof"
   
   // –ó–∞–ø–∏—Å—å heap –ø—Ä–æ—Ñ–∏–ª—è
   f, _ := os.Create("heap.pprof")
   pprof.WriteHeapProfile(f)
   f.Close()
   
   // –ê–Ω–∞–ª–∏–∑ –∞–ª–ª–æ–∫–∞—Ü–∏–π
   go tool pprof -alloc_objects http://localhost:6060/debug/pprof/heap
```

### **10. –ö–∞–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Redis –∏ –∫–∞–∫–∏–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ?**

**–û—Ç–≤–µ—Ç:**
```
–ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ:

1. L1 –∫—ç—à (in-memory –≤ —Å–µ—Ä–≤–∏—Å–µ):
   type LocalCache struct {
       sync.RWMutex
       data map[string]cacheEntry
   }
   
   // TTL: 1-5 —Å–µ–∫—É–Ω–¥
   // –î–ª—è –æ—á–µ–Ω—å –≥–æ—Ä—è—á–∏—Ö –¥–∞–Ω–Ω—ã—Ö

2. L2 –∫—ç—à (Redis):
   // –°—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö:
   
   // –î–ª—è —Ç–µ–∫—É—â–∏—Ö –ø–æ–∑–∏—Ü–∏–π (HSET)
   HSET vehicle:current:truck_123 
        "lat" "55.7558"
        "lon" "37.6176" 
        "speed" "65.2"
   EXPIRE 7200  // 2 —á–∞—Å–∞
   
   // –î–ª—è –≥–µ–æ–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (GEO)
   GEOADD vehicles:geoindex 37.6176 55.7558 "truck_123"
   
   // –î–ª—è –∫—ç—à–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ (String)
   SET cache:vehicle_info:truck_123 '{"model":"Volvo","year":2020}' EX 300
   
   // –î–ª—è —Å—á–µ—Ç—á–∏–∫–æ–≤ (INCR)
   INCR vehicle:messages:truck_123
   EXPIRE 86400  // 1 –¥–µ–Ω—å

3. –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è:

   a) Cache-aside (lazy loading):
      func GetVehicleInfo(id string) (*VehicleInfo, error) {
          // –ü—Ä–æ–±—É–µ–º –∏–∑ –∫—ç—à–∞
          data, err := redis.Get("vehicle:" + id)
          if err == nil {
              return unmarshal(data)
          }
          
          // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ –ë–î
          info, err := db.GetVehicle(id)
          if err != nil {
              return nil, err
          }
          
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
          redis.Set("vehicle:" + id, marshal(info), EXPIRY)
          return info
      }

   b) Write-through:
      func UpdateVehiclePosition(id string, pos Position) error {
          // –û–±–Ω–æ–≤–ª—è–µ–º –≤ –ë–î
          err := db.UpdatePosition(id, pos)
          if err != nil {
              return err
          }
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –≤ –∫—ç—à–µ
          redis.Set("vehicle:pos:" + id, marshal(pos), EXPIRY)
          return nil
      }

   c) Write-behind:
      // –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–ø–∏—Å—å
      func UpdatePositionAsync(id string, pos Position) {
          // –°—Ä–∞–∑—É –≤ –∫—ç—à
          redis.Set("vehicle:pos:" + id, marshal(pos), EXPIRY)
          
          // –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –≤ –ë–î
          go func() {
              db.UpdatePosition(id, pos)
          }()
      }

4. –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞:
   // –ü–æ TTL
   SET key value EX 300
   
   // –Ø–≤–Ω–∞—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è
   DEL vehicle:current:truck_123
   
   // –ü–æ —Å–æ–±—ã—Ç–∏—è–º
   PUBLISH vehicle:updated truck_123
   // –°–µ—Ä–≤–∏—Å—ã –ø–æ–¥–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –∏ –∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É—é—Ç —Å–≤–æ–π –∫—ç—à

5. –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π –∫—ç—à (Redis Cluster):
   // 6 —É–∑–ª–æ–≤: 3 master, 3 replica
   // –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –∫–ª—é—á—É
   slot = CRC16(key) mod 16384
   
   // –ü–µ—Ä–µ—Å—ã–ª–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –ø—Ä–∏ MOVED
   // –†–µ–ø–ª–∏–∫–∞—Ü–∏—è –¥–ª—è –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏

6. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫—ç—à–∞:
   // Hit rate
   hits = INFO stats_keyspace_hits
   misses = INFO stats_keyspace_misses
   hit_rate = hits / (hits + misses)
   
   // Memory usage
   used_memory = INFO used_memory
   maxmemory = CONFIG GET maxmemory
   
   // Evictions
   evicted_keys = INFO evicted_keys
```

### **11. –ö–∞–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç–µ deadlocks –≤ PostgreSQL?**

**–û—Ç–≤–µ—Ç:**
```
–ú–µ—Ö–∞–Ω–∏–∑–º –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ deadlocks:

1. PostgreSQL –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç deadlocks:
   -- –ü—Ä–æ—Ü–µ—Å—Å 1
   BEGIN;
   UPDATE vehicles SET status = 'moving' WHERE id = 1;
   -- –∂–¥–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –æ—Ç –ø—Ä–æ—Ü–µ—Å—Å–∞ 2
   UPDATE vehicles SET status = 'idle' WHERE id = 2;
   
   -- –ü—Ä–æ—Ü–µ—Å—Å 2
   BEGIN;
   UPDATE vehicles SET status = 'idle' WHERE id = 2;
   -- –∂–¥–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –æ—Ç –ø—Ä–æ—Ü–µ—Å—Å–∞ 1
   UPDATE vehicles SET status = 'moving' WHERE id = 1;
   
   -- PostgreSQL –≤—ã–±–µ—Ä–µ—Ç –∂–µ—Ä—Ç–≤—É –∏ –æ—Ç–∫–∞—Ç–∏—Ç –æ–¥–Ω—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é

2. –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è:
   a) –ï–¥–∏–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫:
      // –í—Å–µ–≥–¥–∞ –±–ª–æ–∫–∏—Ä—É–µ–º –∑–∞–ø–∏—Å–∏ –≤ –ø–æ—Ä—è–¥–∫–µ id
      func updateVehicles(ids []int) {
          sort.Ints(ids)  // —Å–æ—Ä—Ç–∏—Ä—É–µ–º
          for _, id := range ids {
              db.Exec("UPDATE vehicles SET ... WHERE id = $1", id)
          }
      }
   
   b) –ö–æ—Ä–æ—Ç–∫–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:
      // –í–º–µ—Å—Ç–æ –æ–¥–Ω–æ–π –¥–ª–∏–Ω–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
      BEGIN;
      UPDATE table1 ...;
      UPDATE table2 ...;
      COMMIT;
      
      // –î–µ–ª–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–æ—Ä–æ—Ç–∫–∏—Ö
      BEGIN; UPDATE table1 ...; COMMIT;
      BEGIN; UPDATE table2 ...; COMMIT;
   
   c) Lock timeout:
      SET lock_timeout = '5s';  // —Ç–∞–π–º–∞—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
      
   d) NOWAIT:
      SELECT ... FOR UPDATE NOWAIT;
      -- –ï—Å–ª–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ - —Å—Ä–∞–∑—É –æ—à–∏–±–∫–∞

3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ deadlocks:
   -- –í–∫–ª—é—á–µ–Ω–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
   log_lock_waits = on
   deadlock_timeout = 1s
   
   -- –ü—Ä–æ—Å–º–æ—Ç—Ä –∞–∫—Ç–∏–≤–Ω—ã—Ö –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫
   SELECT 
       blocked_locks.pid AS blocked_pid,
       blocking_locks.pid AS blocking_pid,
       blocked_activity.query AS blocked_query,
       blocking_activity.query AS blocking_query
   FROM pg_catalog.pg_locks blocked_locks
   JOIN pg_catalog.pg_stat_activity blocked_activity 
       ON blocked_activity.pid = blocked_locks.pid
   JOIN pg_catalog.pg_locks blocking_locks 
       ON blocking_locks.locktype = blocked_locks.locktype
       AND blocking_locks.DATABASE IS NOT DISTINCT FROM blocked_locks.DATABASE
       AND blocking_locks.relation IS NOT DISTINCT FROM blocked_locks.relation
       AND blocking_locks.page IS NOT DISTINCT FROM blocked_locks.page
       AND blocking_locks.tuple IS NOT DISTINCT FROM blocked_locks.tuple
       AND blocking_locks.virtualxid IS NOT DISTINCT FROM blocked_locks.virtualxid
       AND blocking_locks.transactionid IS NOT DISTINCT FROM blocked_locks.transactionid
       AND blocking_locks.classid IS NOT DISTINCT FROM blocked_locks.classid
       AND blocking_locks.objid IS NOT DISTINCT FROM blocked_locks.objid
       AND blocking_locks.objsubid IS NOT DISTINCT FROM blocked_locks.objsubid
       AND blocking_locks.pid != blocked_locks.pid
   JOIN pg_catalog.pg_stat_activity blocking_activity 
       ON blocking_activity.pid = blocking_locks.pid
   WHERE NOT blocked_locks.GRANTED;

4. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è high concurrency:
   a) Row-level locks –≤–º–µ—Å—Ç–æ table locks
   b) –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ advisory locks –¥–ª—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏
      SELECT pg_advisory_xact_lock(hashtext('vehicle_' || vehicle_id));
      -- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
   
   c) Optimistic locking:
      -- –ò—Å–ø–æ–ª—å–∑—É–µ–º version field
      UPDATE vehicles 
      SET status = 'moving', version = version + 1
      WHERE id = 1 AND version = 2;
      -- –ü—Ä–æ–≤–µ—Ä—è–µ–º affected rows
   
   d) Serializable isolation level –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:
      BEGIN ISOLATION LEVEL SERIALIZABLE;
      -- PostgreSQL –∏—Å–ø–æ–ª—å–∑—É–µ—Ç predicate locking
      -- –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç serializable execution

5. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ retry –ø—Ä–∏ deadlocks:
   func execWithRetry(query string, args ...interface{}) error {
       maxRetries := 3
       for i := 0; i < maxRetries; i++ {
           _, err := db.Exec(query, args...)
           if err == nil {
               return nil
           }
           
           // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —ç—Ç–æ deadlock?
           if isDeadlockError(err) {
               // –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
               time.Sleep(time.Duration(math.Pow(2, float64(i))) * time.Second)
               continue
           }
           
           return err
       }
       return errors.New("max retries exceeded")
   }
```

## üîß –ü—Ä–æ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏ –¥–µ–ø–ª–æ–π

### **12. –ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Kubernetes?**

**–û—Ç–≤–µ—Ç:**
```
–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è HPA (Horizontal Pod Autoscaler):

apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: realtime-service-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: realtime-service
  minReplicas: 3
  maxReplicas: 20
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
  - type: Pods
    pods:
      metric:
        name: connections_per_pod
        targetAverageValue: 1000
  - type: External
    external:
      metric:
        name: kafka_lag
      target:
        type: AverageValue
        averageValue: 1000
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 60
      policies:
      - type: Pods
        value: 2
        periodSeconds: 30
      - type: Percent
        value: 50
        periodSeconds: 60
      selectPolicy: Max
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Pods
        value: 1
        periodSeconds: 60
      selectPolicy: Min

–ö–∞—Å—Ç–æ–º–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏:

// Prometheus adapter –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫
apiVersion: autoscaling/v2beta2
kind: HorizontalPodAutoscaler
metadata:
  name: processing-service-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: processing-service
  minReplicas: 2
  maxReplicas: 10
  metrics:
  - type: Pods
    pods:
      metric:
        name: messages_processed_per_second
      target:
        type: AverageValue
        averageValue: 5000

// –ú–µ—Ç—Ä–∏–∫–∞ –≤ Prometheus
# HELP messages_processed_per_second Number of messages processed per second
# TYPE messages_processed_per_second gauge
messages_processed_per_second{service="processing"} 4567.89

VPA (Vertical Pod Autoscaler) –¥–ª—è –ø–∞–º—è—Ç–∏:

apiVersion: autoscaling.k8s.io/v1
kind: VerticalPodAutoscaler
metadata:
  name: ingestion-service-vpa
spec:
  targetRef:
    apiVersion: "apps/v1"
    kind: Deployment
    name: ingestion-service
  updatePolicy:
    updateMode: "Auto"
  resourcePolicy:
    containerPolicies:
    - containerName: "*"
      minAllowed:
        cpu: "100m"
        memory: "256Mi"
      maxAllowed:
        cpu: "2000m"
        memory: "4Gi"
      controlledResources: ["cpu", "memory"]

Cluster Autoscaler –¥–ª—è —É–∑–ª–æ–≤:

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Cluster Autoscaler
apiVersion: v1
kind: ConfigMap
metadata:
  name: cluster-autoscaler
  namespace: kube-system
data:
  cloud-config: |
    [global]
    node-group-defaults:
      min-size: 3
      max-size: 20
    node-groups:
      - name: standard-pool
        min-size: 3
        max-size: 10
        machine-type: n2-standard-4
        labels:
          node-pool: standard
      - name: memory-pool
        min-size: 1
        max-size: 5
        machine-type: n2-highmem-8
        labels:
          node-pool: memory
        taints:
          - key: memory-intensive
            value: "true"
            effect: NoSchedule

–ê–≤—Ç–æ–º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ–±—ã—Ç–∏–π (KEDA):

# KEDA –¥–ª—è Kafka-based scaling
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: kafka-scaledobject
  namespace: default
spec:
  scaleTargetRef:
    name: processing-service
  pollingInterval: 30
  cooldownPeriod: 300
  minReplicaCount: 2
  maxReplicaCount: 20
  triggers:
  - type: kafka
    metadata:
      bootstrapServers: kafka-broker:9092
      consumerGroup: processing-group
      topic: parsed.positions
      lagThreshold: "1000"
      offsetResetPolicy: latest

Graceful scaling:

// Pre-stop hook –¥–ª—è graceful shutdown
containers:
- name: realtime-service
  lifecycle:
    preStop:
      exec:
        command:
        - /bin/sh
        - -c
        - |
          # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–∏–≥–Ω–∞–ª –æ graceful shutdown
          curl -X POST http://localhost:8080/health/ready?shutdown=1
          # –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
          sleep 30
          
// Readiness probe –¥–ª—è –¥—Ä–µ–Ω–∞–∂–∞ —Ç—Ä–∞—Ñ–∏–∫–∞
readinessProbe:
  httpGet:
    path: /health/ready
    port: 8080
  initialDelaySeconds: 5
  periodSeconds: 5
  failureThreshold: 3
  successThreshold: 1

Pod Disruption Budget:

apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: realtime-service-pdb
spec:
  minAvailable: "50%"  // –ò–ª–∏ maxUnavailable: 1
  selector:
    matchLabels:
      app: realtime-service

–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ autoscaling:

# –î–∞—à–±–æ—Ä–¥ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ autoscaling
kubectl get hpa --watch
kubectl top pods
kubectl describe hpa realtime-service-hpa

# –õ–æ–≥–∏ Cluster Autoscaler
kubectl logs -f deployment/cluster-autoscaler -n kube-system
```

### **13. –ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å Prometheus –∏ –∫–∞–∫–∏–µ –∞–ª–µ—Ä—Ç—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã?**

**–û—Ç–≤–µ—Ç:**
```
–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  Prometheus Server                   ‚îÇ
‚îÇ  ‚Ä¢ Scrape targets –∫–∞–∂–¥—ã–µ 15 —Å–µ–∫—É–Ω–¥                  ‚îÇ
‚îÇ  ‚Ä¢ Rules evaluation –∫–∞–∂–¥—ã–µ 15 —Å–µ–∫—É–Ω–¥                ‚îÇ
‚îÇ  ‚Ä¢ Remote write –≤ Thanos –¥–ª—è –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   Alertmanager                       ‚îÇ
‚îÇ  ‚Ä¢ –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –∞–ª–µ—Ä—Ç–æ–≤                              ‚îÇ
‚îÇ  ‚Ä¢ –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è                                     ‚îÇ
‚îÇ  ‚Ä¢ –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è (email, Slack, PagerDuty)         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Prometheus:

global:
  scrape_interval: 15s
  evaluation_interval: 15s

rule_files:
  - "alerts/*.yml"

scrape_configs:
  # –°–µ—Ä–≤–∏—Å—ã
  - job_name: 'ingestion-service'
    static_configs:
      - targets: ['ingestion-service:8080']
    metrics_path: /metrics
    
  - job_name: 'processing-service'
    static_configs:
      - targets: ['processing-service:8080']
      
  # –ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
  - job_name: 'postgresql'
    static_configs:
      - targets: ['postgresql-exporter:9187']
      
  - job_name: 'redis'
    static_configs:
      - targets: ['redis-exporter:9121']
      
  - job_name: 'kafka'
    static_configs:
      - targets: ['kafka-exporter:9308']
      
  # Kubernetes
  - job_name: 'kubernetes-pods'
    kubernetes_sd_configs:
      - role: pod
    relabel_configs:
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        action: keep
        regex: true

–ö–ª—é—á–µ–≤—ã–µ –∞–ª–µ—Ä—Ç—ã:

1. SLA –∞–ª–µ—Ä—Ç—ã:
   # 99.9% –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
   - alert: APIAvailabilityBelowSLA
     expr: |
       sum(rate(http_requests_total{status=~"5.."}[5m])) 
       / sum(rate(http_requests_total[5m])) > 0.001
     for: 5m
     labels:
       severity: critical
     annotations:
       summary: "API availability below 99.9%"
       
2. –ë–∏–∑–Ω–µ—Å-–º–µ—Ç—Ä–∏–∫–∏:
   # –ú–Ω–æ–≥–æ –º–∞—à–∏–Ω offline
   - alert: HighVehicleOfflineRate
     expr: |
       (sum(vehicle_online_status == 0) 
       / count(vehicle_online_status)) > 0.1
     for: 10m
     labels:
       severity: warning
       
3. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:
   # –í—ã—Å–æ–∫–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏
   - alert: HighProcessingLatency
     expr: |
       histogram_quantile(0.99, 
         rate(processing_duration_seconds_bucket[5m])
       ) > 2
     for: 5m
     
4. –†–µ—Å—É—Ä—Å—ã:
   # –í—ã—Å–æ–∫–∞—è –ø–∞–º—è—Ç—å
   - alert: HighMemoryUsage
     expr: |
       (container_memory_working_set_bytes{container!="POD"}
       / container_spec_memory_limit_bytes) > 0.8
     for: 5m
     
5. –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞:
   # Kafka lag
   - alert: HighKafkaLag
     expr: |
       kafka_consumer_group_lag > 10000
     for: 2m
     
6. –ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:
   # –ú–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –≤ PostgreSQL
   - alert: PostgreSQLSlowQueries
     expr: |
       rate(pg_stat_statements_calls[5m]) > 100
       and rate(pg_stat_statements_total_time[5m]) 
       / rate(pg_stat_statements_calls[5m]) > 0.1
     for: 5m

Recording rules –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:

groups:
  - name: recording_rules
    rules:
    # –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø–æ —Å–µ—Ä–≤–∏—Å–∞–º
    - record: service:availability:rate5m
      expr: |
        sum(rate(http_requests_total{status=~"2.."}[5m]))
        / sum(rate(http_requests_total[5m]))
        
    # 95-–π –ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª—å –∑–∞–¥–µ—Ä–∂–∫–∏
    - record: service:latency:p95
      expr: |
        histogram_quantile(0.95,
          sum(rate(http_request_duration_seconds_bucket[5m])) by (le, service)
        )
        
    # –ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ
    - record: container:memory:usage_percentage
      expr: |
        container_memory_working_set_bytes
        / container_spec_memory_limit_bytes * 100

–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Grafana:

# –î–∞—à–±–æ—Ä–¥—ã:
1. –û–±—â–∏–π overview:
   - Uptime —Å–µ—Ä–≤–∏—Å–æ–≤
   - Rate –∑–∞–ø—Ä–æ—Å–æ–≤
   - Error rate
   
2. –ë–∏–∑–Ω–µ—Å-–º–µ—Ç—Ä–∏–∫–∏:
   - –û–Ω–ª–∞–π–Ω –º–∞—à–∏–Ω
   - –°–æ–æ–±—â–µ–Ω–∏–π –≤ —Å–µ–∫—É–Ω–¥—É
   - –ó–∞–¥–µ—Ä–∂–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏
   
3. –ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:
   - QPS, slow queries
   - Connection pool usage
   - Cache hit ratio
   
4. –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞:
   - CPU/Memory usage
   - Network I/O
   - Disk I/O

Alertmanager –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:

route:
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 4h
  
  routes:
  - match:
      severity: critical
    receiver: pagerduty
    continue: true
    
  - match:
      severity: warning
    receiver: slack
    continue: true
    
receivers:
- name: pagerduty
  pagerduty_configs:
  - service_key: <key>
  
- name: slack
  slack_configs:
  - api_url: <url>
    channel: '#alerts'
    
- name: email
  email_configs:
  - to: 'team@example.com'

Blackbox –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–Ω–∞—Ä—É–∂–∏
scrape_configs:
  - job_name: 'blackbox-external'
    metrics_path: /probe
    params:
      module: [http_2xx]
    static_configs:
      - targets:
        - https://realtime.example.com/health
        - https://api.example.com/health
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter:9115
```

–≠—Ç–∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã –ø–æ–∫—Ä—ã–≤–∞—é—Ç —Å–∞–º—ã–µ –≥–ª—É–±–æ–∫–∏–µ –∞—Å–ø–µ–∫—Ç—ã —Å–∏—Å—Ç–µ–º—ã, –ø–æ–∫–∞–∑—ã–≤–∞—è –ø–æ–Ω–∏–º–∞–Ω–∏–µ –Ω–µ —Ç–æ–ª—å–∫–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã, –Ω–æ –∏ –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤, –º–∞—Ç–µ–º–∞—Ç–∏–∫–∏, –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π –∏ –Ω–∏–∑–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã—Ö –¥–µ—Ç–∞–ª–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏.